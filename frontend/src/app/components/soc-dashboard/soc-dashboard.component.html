<!-- Security Operations Center (SOC) Dashboard -->
<div class="min-h-screen bg-slate-900 text-slate-100 overflow-hidden">
  
  <!-- ===================================================================
       HEADER BAR
       ==================================================================== -->
  <header class="fixed top-0 left-0 right-0 h-16 bg-slate-950 border-b border-slate-700 z-40 flex items-center px-6">
    <!-- Logo & Title -->
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 bg-gradient-to-br from-cyan-500 to-emerald-500 rounded-lg flex items-center justify-center">
        <span class="text-white font-bold text-lg">‚óè</span>
      </div>
      <h1 class="text-xl font-bold text-white">Security Operations Center</h1>
    </div>

    <!-- Spacer -->
    <div class="flex-1"></div>

    <!-- Status Indicators -->
    <div class="flex items-center gap-6 pr-6">
      <!-- System Health -->
      <div class="flex items-center gap-2 text-sm">
        <div class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></div>
        <span class="text-slate-400">All Systems Operational</span>
      </div>

      <!-- Current Time -->
      <div class="text-sm text-slate-400 font-mono">
        <span id="currentTime">--:--:--</span>
      </div>

      <!-- User Info -->
      <div class="flex items-center gap-2 text-sm pl-6 border-l border-slate-700">
        <div class="w-8 h-8 bg-cyan-500 rounded-full flex items-center justify-center text-white font-bold">
          {{ (currentUser$ | async)?.name?.charAt(0) }}
        </div>
        <span>{{ (currentUser$ | async)?.name }}</span>
      </div>

      <!-- Sidebar Toggle -->
      <button 
        (click)="toggleSidebar()"
        class="p-2 hover:bg-slate-800 rounded transition-colors ml-4">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
        </svg>
      </button>
    </div>
  </header>

  <!-- ===================================================================
       MAIN LAYOUT (Sidebar + Content)
       ==================================================================== -->
  <div class="pt-16 h-[calc(100vh-64px)] flex">

    <!-- =================================================================
         LEFT SIDEBAR (Navigation)
         ================================================================= -->
    <aside 
      [class.w-64]="sidebarOpen$ | async"
      [class.w-0]="!(sidebarOpen$ | async)"
      class="bg-slate-950 border-r border-slate-700 overflow-hidden transition-all duration-300 flex flex-col">
      
      <!-- Navigation Menu -->
      <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
        
        <!-- Module: Occupancy -->
        <button
          (click)="switchModule('occupancy')"
          [class.bg-slate-800]="(activeModule$ | async) === 'occupancy'"
          [class.border-l-2]="(activeModule$ | async) === 'occupancy'"
          [class.border-l-cyan-500]="(activeModule$ | async) === 'occupancy'"
          class="w-full px-4 py-3 text-left rounded-lg hover:bg-slate-800 transition-colors flex items-center gap-3 text-slate-300 hover:text-white">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 1 1 0 100-2 4 4 0 00-4 4v10a4 4 0 004 4h12a4 4 0 004-4V5a4 4 0 00-4-4 1 1 0 100 2 2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V5z" clip-rule="evenodd" />
          </svg>
          <span>Occupancy</span>
          <span class="ml-auto text-xs bg-cyan-500 text-slate-900 rounded-full px-2 py-1">
            {{ (metrics$ | async)?.[0]?.value }}
          </span>
        </button>

        <!-- Module: Vehicles -->
        <button
          (click)="switchModule('vehicles')"
          [class.bg-slate-800]="(activeModule$ | async) === 'vehicles'"
          [class.border-l-2]="(activeModule$ | async) === 'vehicles'"
          [class.border-l-cyan-500]="(activeModule$ | async) === 'vehicles'"
          class="w-full px-4 py-3 text-left rounded-lg hover:bg-slate-800 transition-colors flex items-center gap-3 text-slate-300 hover:text-white">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path d="M8.5 9a4.5 4.5 0 100-9 4.5 4.5 0 000 9zM1.865 20c0-5.338 3.03-9.972 7.48-11.681.486.15.971.366 1.441.636C11.54 9.128 13.022 9 14.5 9c1.477 0 2.96.128 4.314.455.47-.27.955-.486 1.441-.636 4.45 1.709 7.48 6.343 7.48 11.681 0 .921-.078 1.823-.235 2.722H.235C.078 21.823 0 20.921 0 20z" />
          </svg>
          <span>Vehicles & Gate</span>
          <span class="ml-auto text-xs bg-rose-500 text-white rounded-full px-2 py-1">
            {{ (metrics$ | async)?.[2]?.value }}
          </span>
        </button>

        <!-- Module: Attendance -->
        <button
          (click)="switchModule('attendance')"
          [class.bg-slate-800]="(activeModule$ | async) === 'attendance'"
          [class.border-l-2]="(activeModule$ | async) === 'attendance'"
          [class.border-l-cyan-500]="(activeModule$ | async) === 'attendance'"
          class="w-full px-4 py-3 text-left rounded-lg hover:bg-slate-800 transition-colors flex items-center gap-3 text-slate-300 hover:text-white">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path d="M10.5 1.5H5.75A2.25 2.25 0 003.5 3.75v12.5A2.25 2.25 0 005.75 18.5h8.5a2.25 2.25 0 002.25-2.25V6.5m-12 0h12m-9 2.25h6m-6 3h6m-6 3h3" stroke="currentColor" stroke-width="1.5" fill="none"/>
          </svg>
          <span>Attendance</span>
        </button>

        <!-- Module: Identity -->
        <button
          (click)="switchModule('identity')"
          [class.bg-slate-800]="(activeModule$ | async) === 'identity'"
          [class.border-l-2]="(activeModule$ | async) === 'identity'"
          [class.border-l-cyan-500]="(activeModule$ | async) === 'identity'"
          class="w-full px-4 py-3 text-left rounded-lg hover:bg-slate-800 transition-colors flex items-center gap-3 text-slate-300 hover:text-white">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
          </svg>
          <span>Identity & Access</span>
        </button>
      </nav>

      <!-- Divider -->
      <div class="border-t border-slate-700"></div>

      <!-- Export & Admin -->
      <div class="p-4 space-y-2">
        <button 
          (click)="exportReport('pdf')"
          class="w-full px-4 py-2 text-sm bg-slate-800 hover:bg-slate-700 rounded transition-colors flex items-center gap-2">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8 16.5a1 1 0 01-1-1V7.97l-1.293 1.293a1 1 0 11-1.414-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 11-1.414 1.414L9 7.97V15.5a1 1 0 01-1 1z" clip-rule="evenodd" transform="rotate(180)" />
          </svg>
          <span>Export PDF</span>
        </button>

        <button 
          (click)="exportReport('excel')"
          class="w-full px-4 py-2 text-sm bg-slate-800 hover:bg-slate-700 rounded transition-colors flex items-center gap-2">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.172-5.829a1 1 0 011.414 0L9 12.586l1.414-1.415a1 1 0 111.414 1.414l-2 2a1 1 0 01-1.414 0l-2-2a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
          <span>Export Excel</span>
        </button>
      </div>
    </aside>

    <!-- =================================================================
         MAIN CONTENT AREA
         ================================================================= -->
    <main class="flex-1 overflow-hidden flex flex-col">
      
      <!-- Top Metrics Bar -->
      <div class="h-24 bg-slate-900 border-b border-slate-700 p-4 overflow-x-auto">
        <div class="flex gap-4 h-full">
          <ng-container *ngFor="let metric of metrics$ | async; let i = index">
            <div class="flex-shrink-0 w-64 bg-gradient-to-br from-slate-800 to-slate-900 border border-slate-700 rounded-lg p-3 flex flex-col justify-between hover:border-slate-600 transition-colors">
              <!-- Label -->
              <div class="flex items-center justify-between">
                <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">{{ metric.label }}</span>
                <div [class]="'text-xs font-bold ' + (metric.color === 'cyan' ? 'text-cyan-400' : metric.color === 'emerald' ? 'text-emerald-400' : metric.color === 'rose' ? 'text-rose-400' : 'text-amber-400')">
                  {{ getTrendIcon(metric.trend) }}
                </div>
              </div>
              <!-- Value -->
              <div class="flex items-baseline gap-2">
                <span class="text-2xl font-bold text-white">{{ metric.value }}</span>
                <span class="text-xs text-slate-400">{{ metric.unit }}</span>
              </div>
            </div>
          </ng-container>
        </div>
      </div>

      <!-- Content Grid -->
      <div class="flex-1 overflow-auto p-4 grid grid-cols-4 gap-4" *ngIf="(activeModule$ | async) === 'occupancy'">
        
        <!-- Left Column: Video Feeds (3 cols) -->
        <div class="col-span-3 space-y-4 overflow-y-auto max-h-full">
          
          <!-- View Mode Toggle -->
          <div class="flex gap-2 items-center">
            <button 
              (click)="toggleViewMode()"
              class="px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded text-sm transition-colors flex items-center gap-2">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM15 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2h-2zM5 13a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM15 13a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2h-2z" />
              </svg>
              {{ (viewMode$ | async)?.mode === 'single' ? 'Multi-Camera View' : 'Single Camera View' }}
            </button>
          </div>

          <!-- Multi-Camera Grid OR Single Camera -->
          <div 
            *ngIf="(viewMode$ | async)?.mode === 'multi'"
            class="grid gap-3"
            [class.grid-cols-2]="(viewMode$ | async)?.gridSize === 2"
            [class.grid-cols-3]="(viewMode$ | async)?.gridSize === 4"
            [class.grid-cols-3]="(viewMode$ | async)?.gridSize === 6">
            
            <ng-container *ngFor="let camera of cameras$ | async">
              <app-video-feed-tile 
                [camera]="camera"
                [isSelected]="(selectedCameras$ | async)?.includes(camera.id)"
                (click)="selectCamera(camera.id)">
              </app-video-feed-tile>
            </ng-container>
          </div>

          <!-- Single Camera Detailed View -->
          <div *ngIf="(viewMode$ | async)?.mode === 'single'">
            <app-video-feed-detail 
              [camera]="selectedCameraDetails$ | async"
              [liveData]="cameraLiveData$ | async">
            </app-video-feed-detail>
          </div>
        </div>

        <!-- Right Column: Activity Feed & Alerts (1 col) -->
        <div class="col-span-1 space-y-4 overflow-y-auto max-h-full">
          <app-activity-feed 
            [events]="events$ | async"
            (onClear)="clearEvents()">
          </app-activity-feed>
        </div>
      </div>

      <!-- Vehicles Module View -->
      <div class="flex-1 overflow-auto p-4" *ngIf="(activeModule$ | async) === 'vehicles'">
        <div class="grid grid-cols-3 gap-4 h-full">
          <div class="col-span-2">
            <app-vehicle-detection-view 
              [vehicleData]="vehicleData$ | async">
            </app-vehicle-detection-view>
          </div>
          <div>
            <app-activity-feed 
              [events]="events$ | async"
              (onClear)="clearEvents()">
            </app-activity-feed>
          </div>
        </div>
      </div>

      <!-- Attendance Module View -->
      <div class="flex-1 overflow-auto p-4" *ngIf="(activeModule$ | async) === 'attendance'">
        <div class="grid grid-cols-3 gap-4 h-full">
          <div class="col-span-2">
            <app-attendance-view
              [attendanceData]="attendanceData$ | async"
              (onOverride)="openOverrideModal($event)">
            </app-attendance-view>
          </div>
          <div>
            <app-activity-feed 
              [events]="events$ | async"
              (onClear)="clearEvents()">
            </app-activity-feed>
          </div>
        </div>
      </div>

      <!-- Identity Module View -->
      <div class="flex-1 overflow-auto p-4" *ngIf="(activeModule$ | async) === 'identity'">
        <div class="grid grid-cols-3 gap-4 h-full">
          <div class="col-span-2">
            <app-identity-view
              [identityData]="identityData$ | async">
            </app-identity-view>
          </div>
          <div>
            <app-activity-feed 
              [events]="events$ | async"
              (onClear)="clearEvents()">
            </app-activity-feed>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- ===================================================================
       MANUAL OVERRIDE MODAL
       ==================================================================== -->
  <div 
    *ngIf="showOverrideModal$ | async"
    class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-slate-900 border border-slate-700 rounded-lg shadow-2xl max-w-md w-full mx-4">
      <!-- Header -->
      <div class="border-b border-slate-700 px-6 py-4 flex items-center justify-between">
        <h2 class="text-lg font-bold text-white">Manual Attendance Override</h2>
        <button 
          (click)="closeOverrideModal()"
          class="p-1 hover:bg-slate-800 rounded transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Form -->
      <div class="p-6 space-y-4">
        <!-- Employee Selection -->
        <div>
          <label class="block text-sm font-semibold text-slate-300 mb-2">Employee ID</label>
          <input 
            type="text"
            [(ngModel)]="overrideFormData.employee_id"
            placeholder="Enter employee ID"
            class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white placeholder-slate-500 focus:outline-none focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500">
        </div>

        <!-- Date -->
        <div>
          <label class="block text-sm font-semibold text-slate-300 mb-2">Date</label>
          <input 
            type="date"
            [(ngModel)]="overrideFormData.attendance_date"
            class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white focus:outline-none focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500">
        </div>

        <!-- Check-In Time -->
        <div>
          <label class="block text-sm font-semibold text-slate-300 mb-2">Check-In Time</label>
          <input 
            type="time"
            [(ngModel)]="overrideFormData.check_in_time"
            class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white focus:outline-none focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500">
        </div>

        <!-- Check-Out Time -->
        <div>
          <label class="block text-sm font-semibold text-slate-300 mb-2">Check-Out Time</label>
          <input 
            type="time"
            [(ngModel)]="overrideFormData.check_out_time"
            class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white focus:outline-none focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500">
        </div>

        <!-- Status -->
        <div>
          <label class="block text-sm font-semibold text-slate-300 mb-2">Status</label>
          <select 
            [(ngModel)]="overrideFormData.status"
            class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white focus:outline-none focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500">
            <option value="PRESENT">Present</option>
            <option value="ABSENT">Absent</option>
            <option value="LATE">Late</option>
            <option value="HALF_DAY">Half Day</option>
            <option value="ON_LEAVE">On Leave</option>
          </select>
        </div>

        <!-- Reason -->
        <div>
          <label class="block text-sm font-semibold text-slate-300 mb-2">Reason for Override</label>
          <textarea 
            [(ngModel)]="overrideFormData.reason"
            placeholder="Explain the reason for this override"
            rows="3"
            class="w-full px-3 py-2 bg-slate-800 border border-slate-600 rounded text-white placeholder-slate-500 focus:outline-none focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 resize-none"></textarea>
        </div>
      </div>

      <!-- Footer -->
      <div class="border-t border-slate-700 px-6 py-4 flex gap-3">
        <button 
          (click)="closeOverrideModal()"
          class="flex-1 px-4 py-2 bg-slate-800 hover:bg-slate-700 rounded transition-colors text-white font-semibold">
          Cancel
        </button>
        <button 
          (click)="submitOverride()"
          class="flex-1 px-4 py-2 bg-cyan-600 hover:bg-cyan-500 rounded transition-colors text-white font-semibold flex items-center justify-center gap-2">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
          </svg>
          Apply Override
        </button>
      </div>
    </div>
  </div>

  <!-- ===================================================================
       TOAST NOTIFICATION CONTAINER
       ==================================================================== -->
  <div class="fixed bottom-6 right-6 z-50 space-y-3 pointer-events-none">
    <!-- Toasts rendered by toastr service -->
  </div>
</div>

<script>
  // Update current time in header
  setInterval(() => {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    const el = document.getElementById('currentTime');
    if (el) el.textContent = timeStr;
  }, 1000);
</script>
